<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Resources - Metrics</title>
    <link href="./vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="./css/dashboard.css" rel="stylesheet">
    <style>
        .tabs { display: flex; gap: 0; margin-bottom: 20px; border-bottom: 2px solid #495057; flex-wrap: wrap; }
        .tab { padding: 12px 20px; background: transparent; border: none; cursor: pointer; color: #adb5bd; font-weight: 500; border-bottom: 3px solid transparent; }
        .tab.active { color: #0d6efd; border-bottom-color: #0d6efd; }
        .tab:hover { color: #adb5bd; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .resource-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .resource-card { background: #212529; border: 1px solid #495057; border-radius: 8px; padding: 20px; }
        .resource-card h5 { margin-top: 0; color: #fff; margin-bottom: 15px; word-break: break-word; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .resource-card p { margin: 8px 0; color: #adb5bd; font-size: 13px; }
        .resource-card .label { font-weight: bold; color: #e9ecef; }
        .resource-card.stopped { border-left: 4px solid #dc3545; opacity: 0.8; }
        .resource-card.unused { border-left: 4px solid #ffc107; opacity: 0.8; }
        .badge-stopped { background: #dc3545; color: white; font-size: 11px; padding: 3px 8px; border-radius: 3px; font-weight: bold; }
        .badge-unused { background: #ffc107; color: #000; font-size: 11px; padding: 3px 8px; border-radius: 3px; font-weight: bold; }
        .filter-controls { margin: 20px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .filter-controls label { margin: 0; display: flex; align-items: center; gap: 8px; font-weight: normal; cursor: pointer; }
        .empty-state { text-align: center; padding: 40px; color: #6c757d; }
        .section-title { font-size: 16px; font-weight: bold; color: #e9ecef; margin: 25px 0 15px 0; padding-bottom: 10px; border-bottom: 1px solid #495057; }
    </style>
  </head>
  <body class="bg-dark-login">
    <nav class="navbar navbar-dark bg-dark px-3">
      <a class="navbar-brand" href="./dashboard.html">Cloud Optimizer</a>
      <div>
        <a class="btn btn-sm btn-outline-light me-2" href="./clients.html">Back to Clients</a>
        <a id="openChatBtn" class="btn btn-sm btn-outline-light" href="#">Open Chat</a>
      </div>
    </nav>

    <div class="container-fluid dashboard-layout">
      <div class="row g-0">
        <aside class="col-12 col-lg-2 sidebar d-flex flex-column align-items-center py-4">
          <img src="./assets/logo.png" alt="logo" class="sidebar-logo mb-3" />
          <nav class="nav flex-column w-100 px-2">
            <a class="nav-link text-white d-flex align-items-center" href="./dashboard.html">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                <path d="M8.354 1.146a.5.5 0 0 0-.708 0L1 7.793V14.5A1.5 1.5 0 0 0 2.5 16h3A1.5 1.5 0 0 0 7 14.5V11h2v3.5A1.5 1.5 0 0 0 10.5 16h3A1.5 1.5 0 0 0 15 14.5V7.793L8.354 1.146z"/>
              </svg>
              Dashboard
            </a>
            <a class="nav-link text-white d-flex align-items-center" href="./clients.html">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3z"/>
                <path fill-rule="evenodd" d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
              </svg>
              Client Management
            </a>
            <a class="nav-link text-white d-flex align-items-center" href="./admin.html">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3z"/>
                <path fill-rule="evenodd" d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
              </svg>
              User Management
            </a>
            <a class="nav-link text-white d-flex align-items-center" href="./metrics.html">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm3.5 9H8v3.5a.5.5 0 0 1-1 0V9H4.5a.5.5 0 0 1 0-1H7V4.5a.5.5 0 0 1 1 0V8h3.5a.5.5 0 0 1 0 1z"/>
              </svg>
              Metrics
            </a>
            <a class="nav-link text-white d-flex align-items-center mt-3 px-2" href="./clients.html?action=add" role="button" aria-label="Add Client">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                <path d="M8 4a.5.5 0 0 1 .5.5V7.5H11a.5.5 0 0 1 0 1H8.5V11a.5.5 0 0 1-1 0V8.5H5a.5.5 0 0 1 0-1h2.5V4.5A.5.5 0 0 1 8 4z"/>
              </svg>
              Add Client
            </a>
            <a class="nav-link text-white d-flex align-items-center mt-2 px-2 sidebar-signout" href="#" role="button" aria-label="Sign Out">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                <path d="M6 2a1 1 0 0 0-1 1v2h1V3h7v10H6v-2H5v2a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1H6z"/>
                <path d="M.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L1.707 7.5H10.5a.5.5 0 0 1 0 1H1.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
              </svg>
              Sign Out
            </a>
          </nav>
        </aside>

        <main class="col-12 col-lg-10">
          <div class="container-fluid dashboard-wrap">
            <div class="row mt-4">
              <div class="col-12">
                <h3 class="text-white">Cloud Resources</h3>
                <p class="text-muted" id="clientInfo">Loading resources...</p>
                <div class="filter-controls">
                  <button class="btn btn-sm btn-outline-light" onclick="loadResources()">Refresh</button>
                  <button class="btn btn-sm btn-outline-light ms-2" onclick="window.location.href='/clients.html'">Back to Clients</button>
                  <label class="text-muted" style="font-size: 14px;">
                    <input type="checkbox" id="showStoppedFilter" checked onchange="applyFilters()" />
                    Show Stopped/Deallocated
                  </label>
                  <label class="text-muted" style="font-size: 14px;">
                    <input type="checkbox" id="showUnusedFilter" checked onchange="applyFilters()" />
                    Show Unused
                  </label>
                </div>

                <div id="loading" style="display: none; margin: 20px 0;">
                  <span class="spinner-border spinner-border-sm text-light me-2"></span>
                  <span class="text-light">Loading resources...</span>
                </div>

                <div id="error" style="display: none; margin: 20px 0;" class="alert alert-danger"></div>

                <!-- Tabs -->
                <div class="tabs">
                  <button class="tab active" onclick="switchTab(event, 'compute')">Compute</button>
                  <button class="tab" onclick="switchTab(event, 'database')">Database</button>
                  <button class="tab" onclick="switchTab(event, 'storage')">Storage</button>
                  <button class="tab" onclick="switchTab(event, 'networking')">Networking</button>
                  <button class="tab" onclick="switchTab(event, 'security')">Security</button>
                  <button class="tab" onclick="switchTab(event, 'analytics')">Analytics</button>
                  <button class="tab" onclick="switchTab(event, 'messaging')">Messaging</button>
                  <button class="tab" onclick="switchTab(event, 'billing')">Billing & Costs</button>
                </div>

                <!-- Compute Resources -->
                <div id="compute" class="tab-content active">
                  <div id="compute-content"></div>
                </div>

                <!-- Database Resources -->
                <div id="database" class="tab-content">
                  <div id="database-content"></div>
                </div>

                <!-- Storage Resources -->
                <div id="storage" class="tab-content">
                  <div id="storage-content"></div>
                </div>

                <!-- Networking Resources -->
                <div id="networking" class="tab-content">
                  <div id="networking-content"></div>
                </div>

                <!-- Security Resources -->
                <div id="security" class="tab-content">
                  <div id="security-content"></div>
                </div>

                <!-- Analytics Resources -->
                <div id="analytics" class="tab-content">
                  <div id="analytics-content"></div>
                </div>

                <!-- Messaging Resources -->
                <div id="messaging" class="tab-content">
                  <div id="messaging-content"></div>
                </div>

                <!-- Billing & Costs -->
                <div id="billing" class="tab-content">
                  <div id="billing-content"></div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script src="./vendor/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="./js/common.js"></script>
    <script>
        // Accept either `client_id` or legacy `id` query parameter
        const params = new URLSearchParams(window.location.search);
        const clientId = params.get('client_id') || params.get('id') || 1;
        const token = localStorage.getItem('token');
        let currentResources = null;

        async function loadResources() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';

                const response = await fetch(`/api/metrics/resources/${clientId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                  const text = await response.text().catch(() => null);
                  throw new Error(`HTTP ${response.status}${text ? ': ' + text : ''}`);
                }

                const data = await response.json();
                currentResources = data;
                document.getElementById('clientInfo').textContent = `${data.client_name} (${data.provider.toUpperCase()})`;
                renderResources(data);
            } catch (error) {
                document.getElementById('error').textContent = `Error loading resources: ${error.message}`;
                document.getElementById('error').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function renderResources(data) {
            const resources = data.resources || {};

            ['compute', 'database', 'storage', 'networking', 'security', 'analytics', 'messaging'].forEach(category => {
                const categoryData = resources[category] || {};
                const content = document.getElementById(`${category}-content`);
                let html = '';

                Object.entries(categoryData).forEach(([resourceType, items]) => {
                    if (Array.isArray(items) && items.length > 0) {
                        html += `<div class="section-title">${formatKey(resourceType)}</div>`;
                        html += '<div class="resource-grid">';
                        items.forEach(item => {
                          html += renderResourceCard(item, resourceType, data.provider);
                        });
                        html += '</div>';
                    }
                });

                if (!html) {
                    html = '<div class="empty-state">No resources found in this category</div>';
                }

                content.innerHTML = html;
            });

            // Render billing tab
            const billingContent = document.getElementById('billing-content');
            billingContent.innerHTML = renderBillingTab(data);
        }

        function renderResourceCard(item, resourceType, provider) {
            // Determine if resource is stopped or unused
            const isStopped = item.state && ['stopped', 'deallocated', 'terminated', 'offline'].some(s => item.state.toLowerCase().includes(s));
            const isUnused = item.unused === true;
            const cardClass = isStopped ? 'stopped' : isUnused ? 'unused' : '';
            
            let html = `<div class="resource-card ${cardClass}">`; 
            
            const title = item.name || item.id || item.bucket || item.account || 'Unknown';
            let badges = '';
            if (isStopped) badges += '<span class="badge-stopped">Stopped</span>';
            if (isUnused) badges += '<span class="badge-unused">Unused</span>';
            html += `<h5>${title}${badges ? ' ' + badges : ''}</h5>`;
            Object.entries(item).forEach(([key, value]) => {
                if (key === 'name' || key === 'id' || value === null || value === undefined) return;
                if (typeof value === 'object') return;
                
                html += `<p><span class="label">${formatKey(key)}:</span> ${value}</p>`;
            });

          // Action buttons
          html += `<p><a href="#" class="btn btn-sm btn-outline-light" onclick='event.preventDefault(); showDetails(${JSON.stringify(item)}, "${resourceType}", "${provider}", ${clientId})'>Details</a></p>`;

          html += '</div>';
            return html;
        }

        // Show modal with comprehensive resource details from API
        async function showDetails(item, resourceType, provider, tenantId) {
          const modalId = 'resourceDetailModal';
          let modal = document.getElementById(modalId);
          if (!modal) {
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal fade';
            modal.innerHTML = `
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
              <div class="modal-content" style="background: #0d1117; border: 1px solid #30363d;">
              <div class="modal-header" style="border-bottom: 1px solid #30363d;">
                <h5 class="modal-title text-light">
                  <i class="bi bi-info-circle-fill text-primary me-2"></i>Resource Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body" id="resourceDetailBody" style="background: #0d1117;">
                <div class="text-center p-5">
                  <div class="spinner-border text-primary mb-3" role="status"></div>
                  <p class="text-light">Loading comprehensive details...</p>
                </div>
              </div>
              </div>
            </div>`;
            document.body.appendChild(modal);
          }

          const body = modal.querySelector('#resourceDetailBody');
          
          // Show loading state
          body.innerHTML = `
            <div class="text-center p-5">
              <div class="spinner-border text-primary mb-3" role="status"></div>
              <p class="text-light">Fetching detailed information from ${provider.toUpperCase()}...</p>
            </div>`;

          const bsModal = new bootstrap.Modal(modal);
          bsModal.show();
          
          // Fetch comprehensive details from API
          try {
            const resourceId = item.id || item.name || item.bucket || item.account;
            const response = await fetch(
              `/api/metrics/resource-details/${tenantId}/${encodeURIComponent(resourceType)}/${encodeURIComponent(resourceId)}`,
              { headers: { 'Authorization': `Bearer ${token}` } }
            );
            
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            // Build beautiful UI for details
            const resourceName = item.name || item.id || item.bucket || 'Unknown Resource';
            const providerIcon = provider === 'aws' ? 'üü†' : provider === 'azure' ? 'üîµ' : 'üî¥';
            const stateInfo = getResourceState(item, data.details);
            
            let detailsHtml = `
              <div class="card mb-3" style="background: #161b22; border: 1px solid #30363d;">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                      <h4 class="text-light mb-2">${providerIcon} ${resourceName}</h4>
                      <div class="d-flex gap-2 flex-wrap">
                        <span class="badge" style="background: #238636; font-size: 12px;">
                          <i class="bi bi-hdd-stack me-1"></i>${formatKey(resourceType)}
                        </span>
                        <span class="badge" style="background: #1f6feb; font-size: 12px;">
                          <i class="bi bi-cloud me-1"></i>${provider.toUpperCase()}
                        </span>
                        ${stateInfo.badge}
                      </div>
                    </div>
                    <div class="text-end">
                      ${stateInfo.icon}
                    </div>
                  </div>
                </div>
              </div>`;
            
            // Display fetched details in organized sections
            if (data.details && Object.keys(data.details).length > 0) {
              const accordion_id = 'detailsAccordion_' + Date.now();
              detailsHtml += `<div class="accordion" id="${accordion_id}">`;
              
              let idx = 0;
              for (const [section, sectionData] of Object.entries(data.details)) {
                if (section === 'error') {
                  detailsHtml += `<div class="alert alert-warning mb-3"><i class="bi bi-exclamation-triangle me-2"></i>${sectionData}</div>`;
                  continue;
                }
                
                const sectionId = `section_${idx}`;
                const isFirst = idx === 0;
                const sectionIcon = getSectionIcon(section);
                
                detailsHtml += `
                  <div class="accordion-item" style="background: #161b22; border: 1px solid #30363d; margin-bottom: 8px;">
                    <h2 class="accordion-header">
                      <button class="accordion-button ${isFirst ? '' : 'collapsed'}" type="button" 
                              data-bs-toggle="collapse" data-bs-target="#${sectionId}"
                              style="background: #161b22; color: #e6edf3; border: none; font-size: 14px; padding: 12px 16px;">
                        ${sectionIcon} <strong>${formatKey(section)}</strong>
                        <span class="badge bg-secondary ms-2" style="font-size: 10px;">
                          ${Array.isArray(sectionData) ? sectionData.length + ' items' : typeof sectionData === 'object' ? Object.keys(sectionData).length + ' properties' : ''}
                        </span>
                      </button>
                    </h2>
                    <div id="${sectionId}" class="accordion-collapse collapse ${isFirst ? 'show' : ''}" data-bs-parent="#${accordion_id}">
                      <div class="accordion-body" style="background: #0d1117; padding: 16px;">`;
                
                if (Array.isArray(sectionData) && sectionData.length > 0) {
                  // Render arrays as beautiful cards
                  detailsHtml += '<div class="row g-3">';
                  sectionData.forEach((arrItem, arrIdx) => {
                    detailsHtml += `<div class="col-md-6">
                      <div class="card h-100" style="background: #161b22; border: 1px solid #30363d;">
                        <div class="card-body p-3">
                          <div class="badge bg-primary mb-2" style="font-size: 10px;">Item ${arrIdx + 1}</div>`;
                    
                    if (typeof arrItem === 'object') {
                      for (const [k, v] of Object.entries(arrItem)) {
                        const formattedValue = formatValue(v, k);
                        detailsHtml += `
                          <div class="mb-2">
                            <small class="text-muted d-block" style="font-size: 11px;">${formatKey(k)}</small>
                            <span class="text-light" style="font-size: 13px;">${formattedValue}</span>
                          </div>`;
                      }
                    } else {
                      detailsHtml += `<span class="text-light">${arrItem}</span>`;
                    }
                    
                    detailsHtml += `</div></div></div>`;
                  });
                  detailsHtml += '</div>';
                } else if (typeof sectionData === 'object' && sectionData !== null) {
                  // Render objects as styled key-value pairs
                  detailsHtml += '<div class="row g-2">';
                  for (const [key, value] of Object.entries(sectionData)) {
                    if (value === null || value === undefined) continue;
                    const formattedValue = formatValue(value, key);
                    const isImportant = isImportantField(key);
                    
                    detailsHtml += `
                      <div class="col-md-6">
                        <div class="d-flex flex-column p-3 rounded" style="background: ${isImportant ? '#1c2128' : '#161b22'}; border-left: 3px solid ${isImportant ? '#1f6feb' : '#30363d'};">
                          <small class="text-muted mb-1" style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">${formatKey(key)}</small>
                          <span class="text-light" style="font-size: 13px; word-break: break-word;">${formattedValue}</span>
                        </div>
                      </div>`;
                  }
                  detailsHtml += '</div>';
                } else {
                  // Render primitives
                  detailsHtml += `<div class="p-3 rounded" style="background: #161b22; border: 1px solid #30363d;">
                    <span class="text-light">${sectionData}</span>
                  </div>`;
                }
                
                detailsHtml += `</div></div></div>`;
                idx++;
              }
              
              detailsHtml += '</div>';
            } else {
              // Fallback to basic item display
              detailsHtml += `
                <div class="card" style="background: #161b22; border: 1px solid #30363d;">
                  <div class="card-header" style="background: #1c2128; border-bottom: 1px solid #30363d;">
                    <h6 class="mb-0 text-light"><i class="bi bi-list-ul me-2"></i>Basic Information</h6>
                  </div>
                  <div class="card-body">
                    <div class="row g-2">`;
              
              Object.entries(item).forEach(([key, value]) => {
                if (value === null || value === undefined) return;
                const formattedValue = formatValue(value, key);
                detailsHtml += `
                  <div class="col-md-6">
                    <div class="p-3 rounded" style="background: #0d1117; border-left: 3px solid #30363d;">
                      <small class="text-muted d-block mb-1" style="font-size: 11px;">${formatKey(key)}</small>
                      <span class="text-light" style="font-size: 13px;">${formattedValue}</span>
                    </div>
                  </div>`;
              });
              
              detailsHtml += `</div></div></div>`;
            }
            
            body.innerHTML = detailsHtml;
            
          } catch (error) {
            body.innerHTML = `
              <div class="alert alert-danger" style="background: #3d1b1b; border-color: #d1242f;">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <strong>Error loading details:</strong> ${error.message}
              </div>
              <div class="card" style="background: #161b22; border: 1px solid #30363d;">
                <div class="card-header" style="background: #1c2128;">
                  <h6 class="mb-0 text-light">Basic Information (Cached)</h6>
                </div>
                <div class="card-body">
                  <pre class="text-light" style="white-space:pre-wrap; background: #0d1117; padding: 15px; border-radius: 6px; margin: 0;">${JSON.stringify(item, null, 2)}</pre>
                </div>
              </div>`;
          }
        }

        // Helper: Get resource state and badge
        function getResourceState(item, details) {
          const state = (item.state || item.status || details?.instance?.State?.Name || details?.instance?.status || '').toLowerCase();
          let badge = '';
          let icon = '';
          
          if (state.includes('running') || state.includes('active') || state.includes('available')) {
            badge = '<span class="badge" style="background: #238636; font-size: 12px;"><i class="bi bi-circle-fill me-1"></i>Running</span>';
            icon = '<div class="text-success" style="font-size: 48px;"><i class="bi bi-check-circle-fill"></i></div>';
          } else if (state.includes('stopped') || state.includes('deallocated')) {
            badge = '<span class="badge" style="background: #6e7681; font-size: 12px;"><i class="bi bi-stop-circle-fill me-1"></i>Stopped</span>';
            icon = '<div class="text-secondary" style="font-size: 48px;"><i class="bi bi-pause-circle-fill"></i></div>';
          } else if (state.includes('pending') || state.includes('starting')) {
            badge = '<span class="badge" style="background: #9e6a03; font-size: 12px;"><i class="bi bi-hourglass-split me-1"></i>Pending</span>';
            icon = '<div class="text-warning" style="font-size: 48px;"><i class="bi bi-hourglass-split"></i></div>';
          } else if (state) {
            badge = `<span class="badge bg-info" style="font-size: 12px;">${state}</span>`;
            icon = '<div class="text-info" style="font-size: 48px;"><i class="bi bi-info-circle-fill"></i></div>';
          }
          
          return { badge, icon };
        }

        // Helper: Get section icon
        function getSectionIcon(section) {
          const s = section.toLowerCase();
          if (s.includes('security') || s.includes('groups')) return '<i class="bi bi-shield-lock-fill text-warning me-2"></i>';
          if (s.includes('network') || s.includes('interfaces')) return '<i class="bi bi-diagram-3-fill text-info me-2"></i>';
          if (s.includes('disk') || s.includes('volume') || s.includes('storage')) return '<i class="bi bi-hdd-fill text-primary me-2"></i>';
          if (s.includes('tag')) return '<i class="bi bi-tags-fill text-success me-2"></i>';
          if (s.includes('snapshot')) return '<i class="bi bi-camera-fill text-secondary me-2"></i>';
          if (s.includes('monitor')) return '<i class="bi bi-graph-up text-danger me-2"></i>';
          if (s.includes('metadata') || s.includes('label')) return '<i class="bi bi-journal-text text-info me-2"></i>';
          if (s.includes('instance') || s.includes('database')) return '<i class="bi bi-server text-primary me-2"></i>';
          return '<i class="bi bi-folder2-open text-muted me-2"></i>';
        }

        // Helper: Check if field is important
        function isImportantField(key) {
          const k = key.toLowerCase();
          return k.includes('state') || k.includes('status') || k.includes('type') || 
                 k.includes('size') || k.includes('engine') || k.includes('version') || 
                 k.includes('region') || k.includes('zone') || k.includes('location');
        }

        // Helper: Format value for display
        function formatValue(value, key, depth = 0) {
          if (value === null || value === undefined) return '<span class="text-muted">-</span>';
          if (typeof value === 'boolean') return value ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>';
          
          if (typeof value === 'object') {
            // Prevent infinite recursion
            if (depth > 3) {
              const jsonStr = JSON.stringify(value, null, 2);
              return `<pre class="mb-0 p-2" style="background: #0d1117; border-radius: 4px; font-size: 10px; max-height: 200px; overflow-y: auto;">${jsonStr}</pre>`;
            }
            
            // Handle arrays
            if (Array.isArray(value)) {
              if (value.length === 0) return '<span class="text-muted">Empty array</span>';
              
              // Check if array contains primitives
              const allPrimitives = value.every(v => typeof v !== 'object' || v === null);
              
              if (allPrimitives) {
                // Simple list for primitive arrays
                return `<div class="mt-1">` + value.map(v => 
                  `<span class="badge bg-secondary me-1 mb-1" style="font-size: 11px;">${v}</span>`
                ).join('') + '</div>';
              }
              
              // Collapsible for complex arrays
              const uniqueId = 'arr_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
              let html = `<details style="cursor: pointer;" class="mt-1">
                <summary class="text-primary" style="font-size: 12px;">
                  <i class="bi bi-list-ul me-1"></i>Show ${value.length} items
                </summary>
                <div class="mt-2" style="border-left: 2px solid #30363d; padding-left: 12px;">`;
              
              value.forEach((item, idx) => {
                if (typeof item === 'object' && item !== null) {
                  html += `<div class="mb-3 p-2 rounded" style="background: #0d1117;">
                    <small class="badge bg-primary mb-2" style="font-size: 10px;">Item ${idx + 1}</small>`;
                  
                  Object.entries(item).forEach(([k, v]) => {
                    html += `<div class="mb-1">
                      <small class="text-muted d-block" style="font-size: 10px;">${formatKey(k)}</small>
                      <div style="font-size: 11px;">${formatValue(v, k, depth + 1)}</div>
                    </div>`;
                  });
                  
                  html += '</div>';
                } else {
                  html += `<div class="mb-1" style="font-size: 11px;">${formatValue(item, '', depth + 1)}</div>`;
                }
              });
              
              html += '</div></details>';
              return html;
            }
            
            // Handle objects
            const keys = Object.keys(value);
            if (keys.length === 0) return '<span class="text-muted">Empty object</span>';
            
            // For small objects (1-3 properties), show inline
            if (keys.length <= 3 && depth < 2) {
              let html = '<div class="mt-1" style="border-left: 2px solid #30363d; padding-left: 8px;">';
              Object.entries(value).forEach(([k, v]) => {
                html += `<div class="mb-1">
                  <small class="text-muted" style="font-size: 10px;">${formatKey(k)}:</small>
                  <span style="font-size: 11px; margin-left: 4px;">${formatValue(v, k, depth + 1)}</span>
                </div>`;
              });
              html += '</div>';
              return html;
            }
            
            // For larger objects, make collapsible
            const uniqueId = 'obj_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            let html = `<details style="cursor: pointer;" class="mt-1">
              <summary class="text-primary" style="font-size: 12px;">
                <i class="bi bi-braces me-1"></i>Show ${keys.length} properties
              </summary>
              <div class="mt-2" style="border-left: 2px solid #30363d; padding-left: 12px;">`;
            
            Object.entries(value).forEach(([k, v]) => {
              html += `<div class="mb-2 p-2 rounded" style="background: #0d1117;">
                <small class="text-muted d-block mb-1" style="font-size: 10px;">${formatKey(k)}</small>
                <div style="font-size: 11px;">${formatValue(v, k, depth + 1)}</div>
              </div>`;
            });
            
            html += '</div></details>';
            return html;
          }
          
          const str = String(value);
          
          // Add badges for status values
          const lower = str.toLowerCase();
          if (lower === 'running' || lower === 'active' || lower === 'available') {
            return '<span class="badge" style="background: #238636;">‚úì ' + str + '</span>';
          }
          if (lower === 'stopped' || lower === 'inactive' || lower === 'deallocated') {
            return '<span class="badge bg-secondary">‚óè ' + str + '</span>';
          }
          if (lower === 'pending' || lower === 'starting') {
            return '<span class="badge" style="background: #9e6a03;">‚ü≥ ' + str + '</span>';
          }
          if (lower === 'error' || lower === 'failed') {
            return '<span class="badge bg-danger">‚úó ' + str + '</span>';
          }
          
          // Format timestamps
          if ((key.toLowerCase().includes('time') || key.toLowerCase().includes('date')) && !isNaN(Date.parse(str))) {
            const date = new Date(str);
            return `${str}<br><small class="text-muted" style="font-size: 10px;">${date.toLocaleString()}</small>`;
          }
          
          // Truncate very long strings
          if (str.length > 150) {
            return `<details style="cursor: pointer;">
              <summary class="text-primary" style="font-size: 11px;">Show full text (${str.length} chars)</summary>
              <div class="mt-1 p-2 rounded" style="background: #0d1117; font-size: 11px; word-break: break-all;">${str}</div>
            </details>`;
          }
          
          return str;
        }

        // Generate cloud console link templates for common resources
        function generateConsoleLink(provider, resourceType, id) {
          provider = (provider || '').toLowerCase();
          resourceType = (resourceType || '').toLowerCase();
          if (provider === 'aws') {
            if (resourceType.includes('ec2') || resourceType.includes('instances')) return `https://console.aws.amazon.com/ec2/v2/home?region=${'us-east-1'}#Instances:instanceId=${id}`;
            if (resourceType.includes('s3')) return `https://s3.console.aws.amazon.com/s3/buckets/${id}`;
            if (resourceType.includes('rds')) return `https://console.aws.amazon.com/rds/home?region=${'us-east-1'}#/database:id=${id};is-cluster=false`;
            if (resourceType.includes('vpc')) return `https://console.aws.amazon.com/vpc/home?region=${'us-east-1'}#vpcs:filter=${id}`;
          }
          if (provider === 'azure') {
            if (resourceType.includes('vm')) return `https://portal.azure.com/#@/resource${'/subscriptions'}/providers/Microsoft.Compute/virtualMachines/${id}`;
            if (resourceType.includes('vnet')) return `https://portal.azure.com/#@/resource${'/subscriptions'}/providers/Microsoft.Network/virtualNetworks/${id}`;
          }
          if (provider === 'gcp') {
            if (resourceType.includes('instances') || resourceType.includes('instance')) return `https://console.cloud.google.com/compute/instancesDetail/zones/-/instances/${id}`;
            if (resourceType.includes('buckets')) return `https://console.cloud.google.com/storage/browser/${id}`;
          }
          return '#';
        }

        function formatKey(key) {
            return key
                .replace(/_/g, ' ')
                .replace(/([A-Z])/g, ' $1')
                .trim()
                .split(' ')
                .map(w => w.charAt(0).toUpperCase() + w.slice(1))
                .join(' ');
        }

        function renderBillingTab(data) {
            const provider = (data.provider || 'aws').toLowerCase();
            const resources = data.resources || {};
            
            let html = `
            <div style="max-width: 900px; margin: 20px 0;">
              <div class="alert alert-info" style="background: #1c4f7c; border-color: #0d6efd;">
                <h5 style="margin-top: 0; color: #fff;">Real-Time Billing Data</h5>
                <p style="margin-bottom: 0; color: #e9ecef;">
                  This application does not currently have direct access to real-time billing data from your cloud provider.
                  To view detailed cost breakdowns and current month charges, please use your cloud provider's native billing portal:
                </p>
              </div>

              <div class="row mt-3 mb-4">
                <div class="col-md-6">
                  <div style="background: #212529; border: 1px solid #495057; border-radius: 8px; padding: 20px; text-align: center;">
                    <h6 style="color: #e9ecef; margin-bottom: 15px;">View Billing Dashboard</h6>
            `;

            if (provider === 'aws') {
                html += `<a href="https://console.aws.amazon.com/billing/home" target="_blank" class="btn btn-primary btn-sm">AWS Billing Console</a>`;
            } else if (provider === 'azure') {
                html += `<a href="https://portal.azure.com/#blade/Microsoft_Azure_Billing/BillingMenuBlade/Overview" target="_blank" class="btn btn-primary btn-sm">Azure Cost Management</a>`;
            } else if (provider === 'gcp') {
                html += `<a href="https://console.cloud.google.com/billing" target="_blank" class="btn btn-primary btn-sm">GCP Billing</a>`;
            } else {
                html += `<p class="text-muted">Select a provider to view billing dashboard</p>`;
            }

            html += `
                    <p class="text-muted mt-3" style="font-size: 12px; margin-bottom: 0;">
                      Click to open your cloud provider's billing dashboard
                    </p>
                  </div>
                </div>

                <div class="col-md-6">
                  <div style="background: #212529; border: 1px solid #495057; border-radius: 8px; padding: 20px;">
                    <h6 style="color: #e9ecef; margin-bottom: 15px;">Resource Summary</h6>
            `;

            // Count resources by type
            let totalResources = 0;
            let countByType = {};
            
            for (const category in resources) {
              for (const resourceType in resources[category]) {
                if (Array.isArray(resources[category][resourceType])) {
                  const count = resources[category][resourceType].filter(r => {
                    const isStopped = r.state && ['stopped', 'deallocated', 'terminated', 'offline'].some(s => r.state.toLowerCase().includes(s));
                    return !isStopped;
                  }).length;
                  if (count > 0) {
                    totalResources += count;
                    countByType[formatKey(resourceType)] = (countByType[formatKey(resourceType)] || 0) + count;
                  }
                }
              }
            }

            html += `<p style="color: #adb5bd; margin: 5px 0;"><strong>Active Resources:</strong> <span style="color: #0d6efd;">${totalResources}</span></p>`;

            for (const type in countByType) {
              html += `<p style="color: #adb5bd; margin: 5px 0; font-size: 13px;">‚Ä¢ ${type}: ${countByType[type]}</p>`;
            }

            html += `
                  </div>
                </div>
              </div>

              <div class="alert alert-warning" style="background: #664d0a; border-color: #ffc107; color: #fff;">
                <h6 style="margin-bottom: 10px; color: #fff;">Estimated Cost Calculation</h6>
                <p style="margin: 5px 0; font-size: 13px;">
                  Accurate cost estimation requires real-time usage metrics and pricing data from your cloud provider.
                  We recommend setting up cost alerts in your billing console to monitor spending.
                </p>
                <p style="margin: 5px 0; font-size: 13px;">
                  For detailed cost analysis, consider using your cloud provider's cost management tools:
                </p>
                <ul style="margin: 10px 0; padding-left: 20px; font-size: 13px;">
                  <li><strong>AWS:</strong> AWS Cost Explorer, Budgets, and Trusted Advisor</li>
                  <li><strong>Azure:</strong> Cost Analysis and Budget Alerts in Cost Management</li>
                  <li><strong>GCP:</strong> Billing Reports and Cost Control Tools</li>
                </ul>
              </div>

              <div style="background: #212529; border: 1px solid #495057; border-radius: 8px; padding: 20px; margin-top: 20px;">
                <h6 style="color: #e9ecef; margin-bottom: 15px;">Cost Optimization Tips</h6>
                <ul style="color: #adb5bd; margin-bottom: 0;">
                  <li>Stop or terminate unused resources to reduce costs</li>
                  <li>Review resource sizing and scale down oversized instances</li>
                  <li>Use reserved instances or commitments for long-running services</li>
                  <li>Enable auto-scaling for variable workloads</li>
                  <li>Monitor unused storage and delete old snapshots/backups</li>
                  <li>Set up billing alerts to catch unexpected cost increases</li>
                </ul>
              </div>
            </div>
            `;
            return html;
        }

        function switchTab(event, tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));

            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
        }

        // Filter resources based on stopped/unused toggles
        function applyFilters() {
            if (!currentResources) return;
            const showStopped = document.getElementById('showStoppedFilter').checked;
            const showUnused = document.getElementById('showUnusedFilter').checked;
            
            const filtered = JSON.parse(JSON.stringify(currentResources)); // deep copy
            
            for (const category in filtered.resources) {
                for (const resourceType in filtered.resources[category]) {
                    if (Array.isArray(filtered.resources[category][resourceType])) {
                        filtered.resources[category][resourceType] = filtered.resources[category][resourceType].filter(item => {
                            const isStopped = item.state && ['stopped', 'deallocated', 'terminated', 'offline'].some(s => item.state.toLowerCase().includes(s));
                            const isUnused = item.unused === true;
                            if (isStopped && !showStopped) return false;
                            if (isUnused && !showUnused) return false;
                            return true;
                        });
                    }
                }
            }
            renderResources(filtered);
        }

        window.addEventListener('load', loadResources);
    </script>
  </body>
</html>
