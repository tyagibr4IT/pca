<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Resources - Metrics</title>
    <link href="./vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="./css/dashboard.css" rel="stylesheet">
    <style>
        /* Metrics Container */
        .metrics-container{
          background:linear-gradient(135deg,rgba(15,23,36,0.95) 0%,rgba(7,16,34,0.95) 100%);
          border-radius:16px;
          border:1px solid rgba(255,255,255,0.06);
          box-shadow:0 8px 32px rgba(0,0,0,0.3);
          overflow:hidden;
        }
        
        /* Metrics Header */
        .metrics-header{
          background:linear-gradient(90deg,rgba(13,110,253,0.15) 0%,rgba(25,135,84,0.15) 100%);
          padding:1.25rem 1.5rem;
          border-bottom:1px solid rgba(255,255,255,0.08);
        }
        .metrics-header-row{
          display:flex;
          align-items:center;
          justify-content:space-between;
          gap:1rem;
          flex-wrap:wrap;
        }
        .metrics-info{
          display:flex;
          align-items:center;
          gap:1rem;
          flex:1;
          min-width:0;
        }
        .client-name-display{
          color:#fff;
          font-weight:600;
          font-size:1.125rem;
          white-space:nowrap;
          overflow:hidden;
          text-overflow:ellipsis;
        }
        .status-badge{
          display:inline-flex;
          align-items:center;
          padding:0.375rem 0.875rem;
          border-radius:20px;
          font-size:0.8rem;
          font-weight:500;
          background:rgba(14,165,233,0.2);
          color:#0ea5e9;
          border:1px solid rgba(14,165,233,0.3);
        }
        .metrics-controls{
          display:flex;
          align-items:center;
          gap:0.75rem;
          flex-shrink:0;
          flex-wrap:wrap;
        }
        
        #clientSelector{
          background:rgba(255,255,255,0.08);
          border:1px solid rgba(255,255,255,0.15);
          color:#fff;
          border-radius:8px;
          padding:0.5rem 1rem;
          min-width:250px;
          max-width:350px;
          font-size:0.9rem;
          cursor:pointer;
        }
        #clientSelector:focus{
          background:rgba(255,255,255,0.12);
          border-color:rgba(102,126,234,0.5);
          box-shadow:0 0 0 3px rgba(102,126,234,0.1);
          outline:none;
        }
        #clientSelector option{
          background:#0f1724;
          color:#fff;
        }
        
        /* Filter Controls */
        .filter-controls{
          padding:1rem 1.5rem;
          background:rgba(0,0,0,0.15);
          border-bottom:1px solid rgba(255,255,255,0.06);
          display:flex;
          gap:1.5rem;
          align-items:center;
          flex-wrap:wrap;
        }
        .filter-controls label{
          margin:0;
          display:flex;
          align-items:center;
          gap:8px;
          font-weight:500;
          cursor:pointer;
          color:rgba(230,238,249,0.9);
          font-size:0.875rem;
          transition:color 0.3s ease;
        }
        .filter-controls label:hover{
          color:#fff;
        }
        .filter-controls input[type="checkbox"]{
          width:18px;
          height:18px;
          cursor:pointer;
          accent-color:#0ea5e9;
        }
        
        /* Metrics Content */
        .metrics-content{
          padding:0;
          background:rgba(0,0,0,0.2);
          min-height:60vh;
          max-height:70vh;
          overflow-y:auto;
        }
        .metrics-content::-webkit-scrollbar{width:8px}
        .metrics-content::-webkit-scrollbar-track{background:rgba(255,255,255,0.02);border-radius:4px}
        .metrics-content::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:4px}
        .metrics-content::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.15)}
        
        .tabs { 
          display: flex; 
          gap: 0; 
          margin-bottom: 0; 
          border-bottom: 2px solid rgba(255,255,255,0.1); 
          flex-wrap: wrap; 
          position: sticky;
          top: 0;
          background: rgba(7,16,34,0.98);
          backdrop-filter: blur(8px);
          z-index: 10;
          padding-top: 0;
          padding-bottom: 0;
          margin-top: 0;
          box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .tab { 
          padding: 12px 18px; 
          background: transparent; 
          border: none; 
          cursor: pointer; 
          color: #adb5bd; 
          font-weight: 500; 
          font-size:0.875rem;
          border-bottom: 3px solid transparent; 
          transition:all 0.3s ease; 
        }
        .tab.active { 
          color: #0ea5e9; 
          border-bottom-color: #0ea5e9; 
          background:rgba(14,165,233,0.05);
        }
        .tab:hover { 
          color: #4ade80; 
          background:rgba(74,222,128,0.05);
        }
        .tab-content { display: none; padding: 1rem; }
        .tab-content.active { display: block; }
        .resource-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .resource-card { background: linear-gradient(135deg,rgba(15,23,36,0.8) 0%,rgba(7,16,34,0.8) 100%); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; overflow: hidden; transition:all 0.3s ease; }
        .resource-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.3)}
        .resource-card h5 { margin-top: 0; color: #fff; margin-bottom: 15px; word-break: break-word; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; overflow-wrap: break-word; }
        .resource-card p { margin: 8px 0; color: #adb5bd; font-size: 13px; word-break: break-word; overflow-wrap: break-word; }
        .resource-card .label { font-weight: bold; color: #e9ecef; }
        .resource-card.stopped { border-left: 4px solid #dc3545; }
        .resource-card.unused { border-left: 4px solid #ffc107; }
        .badge-stopped { background: #dc3545; color: white; font-size: 11px; padding: 3px 8px; border-radius: 3px; font-weight: bold; }
        .badge-unused { background: #ffc107; color: #000; font-size: 11px; padding: 3px 8px; border-radius: 3px; font-weight: bold; }
        .empty-state { text-align: center; padding: 40px; color: #6c757d; }
        .section-title { font-size: 16px; font-weight: bold; color: #e9ecef; margin: 25px 0 15px 0; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        
        @media (max-width:768px){
          .metrics-header-row{flex-direction:column;align-items:stretch}
          .metrics-info{flex-direction:column;align-items:stretch;gap:0.75rem}
          .metrics-controls{justify-content:flex-start;width:100%}
          #clientSelector{max-width:100%}
          .filter-controls{flex-direction:column;align-items:flex-start}
        }
    </style>
  </head>
  <body class="bg-dark-login">
    <nav class="navbar navbar-dark bg-dark px-3">
      <a class="navbar-brand" href="./dashboard.html">Cloud Optimizer</a>
      <div>
        <a class="btn btn-sm btn-outline-light me-2" href="./clients.html">Back to Clients</a>
        <a id="openChatBtn" class="btn btn-sm btn-outline-light me-2" href="./chat.html">Open Chat</a>
        <div class="dropdown d-inline-block">
          <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            <span id="navUsername">User</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark" aria-labelledby="userDropdown">
            <li><span class="dropdown-item-text small"><strong id="dropdownUsername">User</strong></span></li>
            <li><span class="dropdown-item-text small text-muted" id="dropdownRole">Role: member</span></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" id="signOut">Sign Out</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid dashboard-layout">
      <div class="row g-0">
        <aside class="col-12 col-lg-2 sidebar d-flex flex-column align-items-center py-4">
          <img src="./assets/logo.png" alt="logo" class="sidebar-logo mb-3" />
          <nav class="nav flex-column w-100 px-2">
            <a class="nav-link text-white d-flex align-items-center" href="./dashboard.html">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                <path d="M8.354 1.146a.5.5 0 0 0-.708 0L1 7.793V14.5A1.5 1.5 0 0 0 2.5 16h3A1.5 1.5 0 0 0 7 14.5V11h2v3.5A1.5 1.5 0 0 0 10.5 16h3A1.5 1.5 0 0 0 15 14.5V7.793L8.354 1.146z"/>
              </svg>
              Dashboard
            </a>
            <a class="nav-link text-white d-flex align-items-center" href="./clients.html">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3z"/>
                <path fill-rule="evenodd" d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
              </svg>
              Client Management
            </a>
            <a class="nav-link text-white d-flex align-items-center" href="./admin.html">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3z"/>
                <path fill-rule="evenodd" d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
              </svg>
              User Management
            </a>
            <a class="nav-link text-white d-flex align-items-center" href="./metrics.html">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm3.5 9H8v3.5a.5.5 0 0 1-1 0V9H4.5a.5.5 0 0 1 0-1H7V4.5a.5.5 0 0 1 1 0V8h3.5a.5.5 0 0 1 0 1z"/>
              </svg>
              Metrics
            </a>
            <a class="nav-link text-white d-flex align-items-center" href="./chat.html">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
              </svg>
              Chat
            </a>
            <a class="nav-link text-white d-flex align-items-center mt-3 px-2" href="./clients.html?action=add" role="button" aria-label="Add Client">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                <path d="M8 4a.5.5 0 0 1 .5.5V7.5H11a.5.5 0 0 1 0 1H8.5V11a.5.5 0 0 1-1 0V8.5H5a.5.5 0 0 1 0-1h2.5V4.5A.5.5 0 0 1 8 4z"/>
              </svg>
              Add Client
            </a>
            <a class="nav-link text-white d-flex align-items-center mt-2 px-2 sidebar-signout" href="#" role="button" aria-label="Sign Out">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                <path d="M6 2a1 1 0 0 0-1 1v2h1V3h7v10H6v-2H5v2a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1H6z"/>
                <path d="M.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L1.707 7.5H10.5a.5.5 0 0 1 0 1H1.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
              </svg>
              Sign Out
            </a>
          </nav>
        </aside>

        <main class="col-12 col-lg-10">
          <div class="container-fluid dashboard-wrap">
            <div class="row mt-3">
              <div class="col-12 col-lg-11 offset-lg-0">
                <div class="metrics-container">
                  
                  <!-- Metrics Header -->
                  <div class="metrics-header">
                    <div class="metrics-header-row">
                      <div class="metrics-info">
                        <select id="clientSelector" class="form-select" onchange="onClientChange()">
                          <option value="">-- Select a client --</option>
                        </select>
                        <span id="clientInfo" class="client-name-display" style="display:none;"></span>
                      </div>
                      <div class="metrics-controls">
                        <button class="btn btn-sm btn-outline-light" onclick="loadResources(false)">
                          <i class="bi bi-arrow-clockwise"></i> Load Latest
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="loadResources(true)">
                          <i class="bi bi-cloud-download"></i> Refresh
                        </button>
                        <a href="./clients.html" class="btn btn-sm btn-outline-light">
                          <i class="bi bi-arrow-left"></i> Back
                        </a>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Filter Controls -->
                  <div class="filter-controls">
                    <label>
                      <input type="checkbox" id="showStoppedFilter" checked onchange="applyFilters()" />
                      <span>Show Stopped/Deallocated</span>
                    </label>
                    <label>
                      <input type="checkbox" id="showUnusedFilter" checked onchange="applyFilters()" />
                      <span>Show Unused</span>
                    </label>
                  </div>

                  <!-- Metrics Content -->
                  <div class="metrics-content">
                    <div id="loading" style="display: none; margin: 20px 0;">
                      <div style="display: flex; align-items: center; white-space: nowrap;">
                        <span class="spinner-border spinner-border-sm text-light me-2"></span>
                        <span class="text-light" id="loadingText">Loading resources...</span>
                      </div>
                    </div>

                    <div id="error" style="display: none; margin: 20px 0;" class="alert alert-danger"></div>

                    <!-- Tabs -->
                    <div class="tabs">
                      <button class="tab active" onclick="switchTab(event, 'compute')">Compute</button>
                      <button class="tab" onclick="switchTab(event, 'database')">Database</button>
                      <button class="tab" onclick="switchTab(event, 'storage')">Storage</button>
                      <button class="tab" onclick="switchTab(event, 'networking')">Networking</button>
                      <button class="tab" onclick="switchTab(event, 'security')">Security</button>
                      <button class="tab" onclick="switchTab(event, 'api')">API</button>
                      <button class="tab" onclick="switchTab(event, 'analytics')">Analytics</button>
                      <button class="tab" onclick="switchTab(event, 'messaging')">Messaging</button>
                      <button class="tab" onclick="switchTab(event, 'recommendations')">Recommendations</button>
                      <button class="tab" onclick="switchTab(event, 'billing')">Billing & Costs</button>
                    </div>

                    <!-- Compute Resources -->
                    <div id="compute" class="tab-content active">
                      <div id="compute-content"></div>
                    </div>

                    <!-- Database Resources -->
                    <div id="database" class="tab-content">
                      <div id="database-content"></div>
                    </div>

                    <!-- Storage Resources -->
                    <div id="storage" class="tab-content">
                      <div id="storage-content"></div>
                    </div>

                    <!-- Networking Resources -->
                    <div id="networking" class="tab-content">
                      <div id="networking-content"></div>
                    </div>

                    <!-- Security Resources -->
                    <div id="security" class="tab-content">
                      <div id="security-content"></div>
                    </div>

                    <!-- API Resources -->
                    <div id="api" class="tab-content">
                      <div id="api-content"></div>
                    </div>

                    <!-- Analytics Resources -->
                    <div id="analytics" class="tab-content">
                      <div id="analytics-content"></div>
                    </div>

                    <!-- Messaging Resources -->
                    <div id="messaging" class="tab-content">
                      <div id="messaging-content"></div>
                    </div>

                    <!-- Recommendations -->
                    <div id="recommendations" class="tab-content">
                      <div id="recommendations-loading" style="display: none; text-align: center; padding: 40px;">
                        <div class="spinner-border text-primary mb-3" role="status"></div>
                        <p class="text-light">Analyzing resources and generating recommendations...</p>
                      </div>
                      <div id="recommendations-content"></div>
                    </div>

                    <!-- Billing & Costs -->
                    <div id="billing" class="tab-content">
                      <div id="billing-content"></div>
                    </div>
                  </div>
                  
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script src="./vendor/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="./js/config.js"></script>
    <script src="./js/common.js"></script>
    <script>
        // Accept either `client_id` or legacy `id` query parameter
        const params = new URLSearchParams(window.location.search);
        let clientId = params.get('client_id') || params.get('id') || null;
        const token = localStorage.getItem('token');
        let currentResources = null;
        let allClients = [];

        /**
         * Fetch all clients from API and populate dropdown.
         * 
         * This function loads the list of available clients/tenants and populates
         * the dropdown selector. If a client_id is present in the URL, it
         * auto-selects that client.
         */
        async function loadClients() {
            try {
                const response = await fetch('/api/clients/', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error(`Failed to load clients: ${response.status}`);
                }

                allClients = await response.json();
                const selector = document.getElementById('clientSelector');
                
                // Clear existing options except the first placeholder
                selector.innerHTML = '<option value="">-- Select a client to view resources --</option>';
                
                // Populate dropdown with clients
                allClients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = `${client.name} (ID: ${client.id})`;
                    selector.appendChild(option);
                });
                
                // If client_id in URL, auto-select it
                if (clientId) {
                    selector.value = clientId;
                    // Load resources for the selected client
                    loadResources(false);
                }
            } catch (error) {
                console.error('Error loading clients:', error);
                document.getElementById('error').textContent = `Error loading clients: ${error.message}`;
                document.getElementById('error').style.display = 'block';
            }
        }

        /**
         * Handle client dropdown selection change.
         * 
         * When user selects a client from dropdown, update the current clientId
         * and load resources for that client.
         */
        function onClientChange() {
            const selector = document.getElementById('clientSelector');
            const clientInfoDisplay = document.getElementById('clientInfo');
            clientId = selector.value;
            
            if (clientId) {
                // Show client name display
                clientInfoDisplay.style.display = 'inline-block';
                clientInfoDisplay.textContent = 'Loading...';
                
                // Update URL with selected client_id (without page reload)
                const newUrl = new URL(window.location);
                newUrl.searchParams.set('client_id', clientId);
                window.history.pushState({}, '', newUrl);
                
                // Load resources for selected client
                loadResources(false);
            } else {
                // No client selected - clear resources
                clientInfoDisplay.style.display = 'none';
                clientInfoDisplay.textContent = '';
                clearAllResources();
            }
        }

        /**
         * Clear all resource displays when no client is selected.
         */
        function clearAllResources() {
            ['compute', 'database', 'storage', 'networking', 'security', 'api', 'analytics', 'messaging'].forEach(category => {
                const content = document.getElementById(`${category}-content`);
                content.innerHTML = '<div class="empty-state">Please select a client to view resources</div>';
            });
            
            const billingContent = document.getElementById('billing-content');
            if (billingContent) {
                billingContent.innerHTML = '<div class="empty-state">Please select a client to view billing information</div>';
            }
        }

        async function loadResources(forceRefresh = false) {
            // Validate client is selected
            if (!clientId) {
                document.getElementById('clientInfo').innerHTML = 'Please select a client from the dropdown above';
                return;
            }
            try {
                const loadingEl = document.getElementById('loading');
                const errorEl = document.getElementById('error');
                
                loadingEl.style.display = 'block';
                errorEl.style.display = 'none';

                // Update loading message
                const loadingText = document.getElementById('loadingText');
                if (loadingText) {
                    loadingText.textContent = forceRefresh 
                        ? 'Fetching fresh data from cloud provider...' 
                        : 'Loading latest metrics...';
                }

                const url = `/api/metrics/resources/${clientId}${forceRefresh ? '?force_refresh=true' : ''}`;
                console.log('Fetching from:', url);
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                  const text = await response.text().catch(() => null);
                  throw new Error(`HTTP ${response.status}${text ? ': ' + text : ''}`);
                }

                const data = await response.json();
                console.log('API Response:', data);
                console.log('Resources:', data.resources);
                
                currentResources = data;
                
                // Update client info with cache status
                let cacheStatus = '';
                if (data.cached) {
                    const fetchedAt = new Date(data.fetched_at);
                    const minutesAgo = Math.floor((new Date() - fetchedAt) / 60000);
                    cacheStatus = ` <span class="badge bg-success" title="Data fetched ${minutesAgo} minute(s) ago">Cached</span>`;
                } else {
                    cacheStatus = ' <span class="badge bg-info">Fresh from Cloud</span>';
                }
                
                const clientInfoDisplay = document.getElementById('clientInfo');
                clientInfoDisplay.innerHTML = `${data.client_name} (${data.provider.toUpperCase()})${cacheStatus}`;
                clientInfoDisplay.style.display = 'inline-block';
                
                renderResources(data);
            } catch (error) {
                console.error('Error loading resources:', error);
                document.getElementById('error').textContent = `Error loading resources: ${error.message}`;
                document.getElementById('error').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function renderResources(data) {
            const resources = data.resources || {};
            
            console.log('Rendering resources:', resources);
            console.log('Resource keys:', Object.keys(resources));

            ['compute', 'database', 'storage', 'networking', 'security', 'api', 'analytics', 'messaging'].forEach(category => {
                const categoryData = resources[category] || {};
                const content = document.getElementById(`${category}-content`);
                
                console.log(`Category ${category}:`, categoryData);
                
                let html = '';

                Object.entries(categoryData).forEach(([resourceType, items]) => {
                    if (Array.isArray(items) && items.length > 0) {
                        html += `<div class="section-title">${formatKey(resourceType)}</div>`;
                        html += '<div class="resource-grid">';
                        items.forEach(item => {
                          html += renderResourceCard(item, resourceType, data.provider);
                        });
                        html += '</div>';
                    }
                });

                if (!html) {
                    html = '<div class="empty-state">No resources found in this category</div>';
                }

                content.innerHTML = html;
            });

            // Render billing tab
            const billingContent = document.getElementById('billing-content');
            billingContent.innerHTML = renderBillingTab(data);
        }

        function renderResourceCard(item, resourceType, provider) {
            // Determine if resource is stopped or unused
            const isStopped = item.state && ['stopped', 'deallocated', 'terminated', 'offline'].some(s => item.state.toLowerCase().includes(s));
            const isUnused = item.unused === true;
            const cardClass = isStopped ? 'stopped' : isUnused ? 'unused' : '';
            
            let html = `<div class="resource-card ${cardClass}">`; 
            
            const title = item.name || item.id || item.bucket || item.account || 'Unknown';
            let badges = '';
            if (isStopped) badges += '<span class="badge-stopped">Stopped</span>';
            if (isUnused) badges += '<span class="badge-unused">Unused</span>';
            html += `<h5>${title}${badges ? ' ' + badges : ''}</h5>`;
            Object.entries(item).forEach(([key, value]) => {
                if (key === 'name' || key === 'id' || value === null || value === undefined) return;
                if (typeof value === 'object') return;
                
                html += `<p><span class="label">${formatKey(key)}:</span> ${value}</p>`;
            });

          // Action buttons
          html += `<p><a href="#" class="btn btn-sm btn-outline-light" onclick='event.preventDefault(); showDetails(${JSON.stringify(item)}, "${resourceType}", "${provider}", ${clientId})'>Details</a></p>`;

          html += '</div>';
            return html;
        }

        // Show modal with comprehensive resource details from API
        async function showDetails(item, resourceType, provider, tenantId) {
          const modalId = 'resourceDetailModal';
          let modal = document.getElementById(modalId);
          if (!modal) {
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal fade';
            modal.innerHTML = `
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
              <div class="modal-content" style="background: #0d1117; border: 1px solid #30363d;">
              <div class="modal-header" style="border-bottom: 1px solid #30363d;">
                <h5 class="modal-title text-light">
                  <i class="bi bi-info-circle-fill text-primary me-2"></i>Resource Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body" id="resourceDetailBody" style="background: #0d1117;">
                <div class="text-center p-5">
                  <div class="spinner-border text-primary mb-3" role="status"></div>
                  <p class="text-light">Loading comprehensive details...</p>
                </div>
              </div>
              </div>
            </div>`;
            document.body.appendChild(modal);
          }

          const body = modal.querySelector('#resourceDetailBody');
          
          // Show loading state
          body.innerHTML = `
            <div class="text-center p-5">
              <div class="spinner-border text-primary mb-3" role="status"></div>
              <p class="text-light">Fetching detailed information from ${provider.toUpperCase()}...</p>
            </div>`;

          const bsModal = new bootstrap.Modal(modal);
          bsModal.show();
          
          // Fetch comprehensive details from API
          try {
            const resourceId = item.id || item.name || item.bucket || item.account;
            const response = await fetch(
              `/api/metrics/resource-details/${tenantId}/${encodeURIComponent(resourceType)}/${encodeURIComponent(resourceId)}`,
              { headers: { 'Authorization': `Bearer ${token}` } }
            );
            
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            // Build beautiful UI for details
            const resourceName = item.name || item.id || item.bucket || 'Unknown Resource';
            const providerIcon = provider === 'aws' ? 'üü†' : provider === 'azure' ? 'üîµ' : 'üî¥';
            const stateInfo = getResourceState(item, data.details);
            
            let detailsHtml = `
              <div class="card mb-3" style="background: #161b22; border: 1px solid #30363d;">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                      <h4 class="text-light mb-2">${providerIcon} ${resourceName}</h4>
                      <div class="d-flex gap-2 flex-wrap">
                        <span class="badge" style="background: #238636; font-size: 12px;">
                          <i class="bi bi-hdd-stack me-1"></i>${formatKey(resourceType)}
                        </span>
                        <span class="badge" style="background: #1f6feb; font-size: 12px;">
                          <i class="bi bi-cloud me-1"></i>${provider.toUpperCase()}
                        </span>
                        ${stateInfo.badge}
                      </div>
                    </div>
                    <div class="text-end">
                      ${stateInfo.icon}
                    </div>
                  </div>
                </div>
              </div>`;
            
            // Display fetched details in organized sections
            if (data.details && Object.keys(data.details).length > 0) {
              const accordion_id = 'detailsAccordion_' + Date.now();
              detailsHtml += `<div class="accordion" id="${accordion_id}">`;
              
              let idx = 0;
              for (const [section, sectionData] of Object.entries(data.details)) {
                if (section === 'error') {
                  detailsHtml += `<div class="alert alert-warning mb-3"><i class="bi bi-exclamation-triangle me-2"></i>${sectionData}</div>`;
                  continue;
                }
                
                const sectionId = `section_${idx}`;
                const isFirst = idx === 0;
                const sectionIcon = getSectionIcon(section);
                
                detailsHtml += `
                  <div class="accordion-item" style="background: #161b22; border: 1px solid #30363d; margin-bottom: 8px;">
                    <h2 class="accordion-header">
                      <button class="accordion-button ${isFirst ? '' : 'collapsed'}" type="button" 
                              data-bs-toggle="collapse" data-bs-target="#${sectionId}"
                              style="background: #161b22; color: #e6edf3; border: none; font-size: 14px; padding: 12px 16px;">
                        ${sectionIcon} <strong>${formatKey(section)}</strong>
                        <span class="badge bg-secondary ms-2" style="font-size: 10px;">
                          ${Array.isArray(sectionData) ? sectionData.length + ' items' : typeof sectionData === 'object' && sectionData !== null ? Object.keys(sectionData).length + ' properties' : ''}
                        </span>
                      </button>
                    </h2>
                    <div id="${sectionId}" class="accordion-collapse collapse ${isFirst ? 'show' : ''}" data-bs-parent="#${accordion_id}">
                      <div class="accordion-body" style="background: #0d1117; padding: 16px;">`;
                
                if (Array.isArray(sectionData) && sectionData.length > 0) {
                  // Render arrays as beautiful cards
                  detailsHtml += '<div class="row g-3">';
                  sectionData.forEach((arrItem, arrIdx) => {
                    detailsHtml += `<div class="col-md-6">
                      <div class="card h-100" style="background: #161b22; border: 1px solid #30363d;">
                        <div class="card-body p-3">
                          <div class="badge bg-primary mb-2" style="font-size: 10px;">Item ${arrIdx + 1}</div>`;
                    
                    if (typeof arrItem === 'object') {
                      for (const [k, v] of Object.entries(arrItem)) {
                        const formattedValue = formatValue(v, k);
                        detailsHtml += `
                          <div class="mb-2">
                            <small class="text-muted d-block" style="font-size: 11px;">${formatKey(k)}</small>
                            <span class="text-light" style="font-size: 13px;">${formattedValue}</span>
                          </div>`;
                      }
                    } else {
                      detailsHtml += `<span class="text-light">${arrItem}</span>`;
                    }
                    
                    detailsHtml += `</div></div></div>`;
                  });
                  detailsHtml += '</div>';
                } else if (typeof sectionData === 'object' && sectionData !== null) {
                  // Render objects as styled key-value pairs
                  detailsHtml += '<div class="row g-2">';
                  for (const [key, value] of Object.entries(sectionData)) {
                    if (value === null || value === undefined) continue;
                    const formattedValue = formatValue(value, key);
                    const isImportant = isImportantField(key);
                    
                    detailsHtml += `
                      <div class="col-md-6">
                        <div class="d-flex flex-column p-3 rounded" style="background: ${isImportant ? '#1c2128' : '#161b22'}; border-left: 3px solid ${isImportant ? '#1f6feb' : '#30363d'};">
                          <small class="text-muted mb-1" style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">${formatKey(key)}</small>
                          <span class="text-light" style="font-size: 13px; word-break: break-word;">${formattedValue}</span>
                        </div>
                      </div>`;
                  }
                  detailsHtml += '</div>';
                } else {
                  // Render primitives
                  detailsHtml += `<div class="p-3 rounded" style="background: #161b22; border: 1px solid #30363d;">
                    <span class="text-light">${sectionData}</span>
                  </div>`;
                }
                
                detailsHtml += `</div></div></div>`;
                idx++;
              }
              
              detailsHtml += '</div>';
            } else {
              // Fallback to basic item display
              detailsHtml += `
                <div class="card" style="background: #161b22; border: 1px solid #30363d;">
                  <div class="card-header" style="background: #1c2128; border-bottom: 1px solid #30363d;">
                    <h6 class="mb-0 text-light"><i class="bi bi-list-ul me-2"></i>Basic Information</h6>
                  </div>
                  <div class="card-body">
                    <div class="row g-2">`;
              
              Object.entries(item).forEach(([key, value]) => {
                if (value === null || value === undefined) return;
                const formattedValue = formatValue(value, key);
                detailsHtml += `
                  <div class="col-md-6">
                    <div class="p-3 rounded" style="background: #0d1117; border-left: 3px solid #30363d;">
                      <small class="text-muted d-block mb-1" style="font-size: 11px;">${formatKey(key)}</small>
                      <span class="text-light" style="font-size: 13px;">${formattedValue}</span>
                    </div>
                  </div>`;
              });
              
              detailsHtml += `</div></div></div>`;
            }
            
            body.innerHTML = detailsHtml;
            
          } catch (error) {
            body.innerHTML = `
              <div class="alert alert-danger" style="background: #3d1b1b; border-color: #d1242f;">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <strong>Error loading details:</strong> ${error.message}
              </div>
              <div class="card" style="background: #161b22; border: 1px solid #30363d;">
                <div class="card-header" style="background: #1c2128;">
                  <h6 class="mb-0 text-light">Basic Information (Cached)</h6>
                </div>
                <div class="card-body">
                  <pre class="text-light" style="white-space:pre-wrap; background: #0d1117; padding: 15px; border-radius: 6px; margin: 0;">${JSON.stringify(item, null, 2)}</pre>
                </div>
              </div>`;
          }
        }

        // Helper: Get resource state and badge
        function getResourceState(item, details) {
          const state = (item.state || item.status || details?.instance?.State?.Name || details?.instance?.status || '').toLowerCase();
          let badge = '';
          let icon = '';
          
          if (state.includes('running') || state.includes('active') || state.includes('available')) {
            badge = '<span class="badge" style="background: #238636; font-size: 12px;"><i class="bi bi-circle-fill me-1"></i>Running</span>';
            icon = '<div class="text-success" style="font-size: 48px;"><i class="bi bi-check-circle-fill"></i></div>';
          } else if (state.includes('stopped') || state.includes('deallocated')) {
            badge = '<span class="badge" style="background: #6e7681; font-size: 12px;"><i class="bi bi-stop-circle-fill me-1"></i>Stopped</span>';
            icon = '<div class="text-secondary" style="font-size: 48px;"><i class="bi bi-pause-circle-fill"></i></div>';
          } else if (state.includes('pending') || state.includes('starting')) {
            badge = '<span class="badge" style="background: #9e6a03; font-size: 12px;"><i class="bi bi-hourglass-split me-1"></i>Pending</span>';
            icon = '<div class="text-warning" style="font-size: 48px;"><i class="bi bi-hourglass-split"></i></div>';
          } else if (state) {
            badge = `<span class="badge bg-info" style="font-size: 12px;">${state}</span>`;
            icon = '<div class="text-info" style="font-size: 48px;"><i class="bi bi-info-circle-fill"></i></div>';
          }
          
          return { badge, icon };
        }

        // Helper: Get section icon
        function getSectionIcon(section) {
          const s = section.toLowerCase();
          if (s.includes('security') || s.includes('groups')) return '<i class="bi bi-shield-lock-fill text-warning me-2"></i>';
          if (s.includes('network') || s.includes('interfaces')) return '<i class="bi bi-diagram-3-fill text-info me-2"></i>';
          if (s.includes('disk') || s.includes('volume') || s.includes('storage')) return '<i class="bi bi-hdd-fill text-primary me-2"></i>';
          if (s.includes('tag')) return '<i class="bi bi-tags-fill text-success me-2"></i>';
          if (s.includes('snapshot')) return '<i class="bi bi-camera-fill text-secondary me-2"></i>';
          if (s.includes('monitor')) return '<i class="bi bi-graph-up text-danger me-2"></i>';
          if (s.includes('metadata') || s.includes('label')) return '<i class="bi bi-journal-text text-info me-2"></i>';
          if (s.includes('instance') || s.includes('database')) return '<i class="bi bi-server text-primary me-2"></i>';
          return '<i class="bi bi-folder2-open text-muted me-2"></i>';
        }

        // Helper: Check if field is important
        function isImportantField(key) {
          const k = key.toLowerCase();
          return k.includes('state') || k.includes('status') || k.includes('type') || 
                 k.includes('size') || k.includes('engine') || k.includes('version') || 
                 k.includes('region') || k.includes('zone') || k.includes('location');
        }

        // Helper: Format value for display
        function formatValue(value, key, depth = 0) {
          if (value === null || value === undefined) return '<span class="text-muted">-</span>';
          if (typeof value === 'boolean') return value ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>';
          
          if (typeof value === 'object') {
            // Prevent infinite recursion
            if (depth > 3) {
              const jsonStr = JSON.stringify(value, null, 2);
              return `<pre class="mb-0 p-2" style="background: #0d1117; border-radius: 4px; font-size: 10px; max-height: 200px; overflow-y: auto;">${jsonStr}</pre>`;
            }
            
            // Handle arrays
            if (Array.isArray(value)) {
              if (value.length === 0) return '<span class="text-muted">Empty array</span>';
              
              // Check if array contains primitives
              const allPrimitives = value.every(v => typeof v !== 'object' || v === null);
              
              if (allPrimitives) {
                // Simple list for primitive arrays
                return `<div class="mt-1">` + value.map(v => 
                  `<span class="badge bg-secondary me-1 mb-1" style="font-size: 11px;">${v}</span>`
                ).join('') + '</div>';
              }
              
              // Collapsible for complex arrays
              const uniqueId = 'arr_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
              let html = `<details style="cursor: pointer;" class="mt-1">
                <summary class="text-primary" style="font-size: 12px;">
                  <i class="bi bi-list-ul me-1"></i>Show ${value.length} items
                </summary>
                <div class="mt-2" style="border-left: 2px solid #30363d; padding-left: 12px;">`;
              
              value.forEach((item, idx) => {
                if (typeof item === 'object' && item !== null) {
                  html += `<div class="mb-3 p-2 rounded" style="background: #0d1117;">
                    <small class="badge bg-primary mb-2" style="font-size: 10px;">Item ${idx + 1}</small>`;
                  
                  Object.entries(item).forEach(([k, v]) => {
                    html += `<div class="mb-1">
                      <small class="text-muted d-block" style="font-size: 10px;">${formatKey(k)}</small>
                      <div style="font-size: 11px;">${formatValue(v, k, depth + 1)}</div>
                    </div>`;
                  });
                  
                  html += '</div>';
                } else {
                  html += `<div class="mb-1" style="font-size: 11px;">${formatValue(item, '', depth + 1)}</div>`;
                }
              });
              
              html += '</div></details>';
              return html;
            }
            
            // Handle objects
            const keys = Object.keys(value);
            if (keys.length === 0) return '<span class="text-muted">Empty object</span>';
            
            // For small objects (1-3 properties), show inline
            if (keys.length <= 3 && depth < 2) {
              let html = '<div class="mt-1" style="border-left: 2px solid #30363d; padding-left: 8px;">';
              Object.entries(value).forEach(([k, v]) => {
                html += `<div class="mb-1">
                  <small class="text-muted" style="font-size: 10px;">${formatKey(k)}:</small>
                  <span style="font-size: 11px; margin-left: 4px;">${formatValue(v, k, depth + 1)}</span>
                </div>`;
              });
              html += '</div>';
              return html;
            }
            
            // For larger objects, make collapsible
            const uniqueId = 'obj_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            let html = `<details style="cursor: pointer;" class="mt-1">
              <summary class="text-primary" style="font-size: 12px;">
                <i class="bi bi-braces me-1"></i>Show ${keys.length} properties
              </summary>
              <div class="mt-2" style="border-left: 2px solid #30363d; padding-left: 12px;">`;
            
            Object.entries(value).forEach(([k, v]) => {
              html += `<div class="mb-2 p-2 rounded" style="background: #0d1117;">
                <small class="text-muted d-block mb-1" style="font-size: 10px;">${formatKey(k)}</small>
                <div style="font-size: 11px;">${formatValue(v, k, depth + 1)}</div>
              </div>`;
            });
            
            html += '</div></details>';
            return html;
          }
          
          const str = String(value);
          
          // Add badges for status values
          const lower = str.toLowerCase();
          if (lower === 'running' || lower === 'active' || lower === 'available') {
            return '<span class="badge" style="background: #238636;">‚úì ' + str + '</span>';
          }
          if (lower === 'stopped' || lower === 'inactive' || lower === 'deallocated') {
            return '<span class="badge bg-secondary">‚óè ' + str + '</span>';
          }
          if (lower === 'pending' || lower === 'starting') {
            return '<span class="badge" style="background: #9e6a03;">‚ü≥ ' + str + '</span>';
          }
          if (lower === 'error' || lower === 'failed') {
            return '<span class="badge bg-danger">‚úó ' + str + '</span>';
          }
          
          // Format timestamps
          if ((key.toLowerCase().includes('time') || key.toLowerCase().includes('date')) && !isNaN(Date.parse(str))) {
            const date = new Date(str);
            return `${str}<br><small class="text-muted" style="font-size: 10px;">${date.toLocaleString()}</small>`;
          }
          
          // Truncate very long strings
          if (str.length > 150) {
            return `<details style="cursor: pointer;">
              <summary class="text-primary" style="font-size: 11px;">Show full text (${str.length} chars)</summary>
              <div class="mt-1 p-2 rounded" style="background: #0d1117; font-size: 11px; word-break: break-all;">${str}</div>
            </details>`;
          }
          
          return str;
        }

        // Generate cloud console link templates for common resources
        function generateConsoleLink(provider, resourceType, id) {
          provider = (provider || '').toLowerCase();
          resourceType = (resourceType || '').toLowerCase();
          if (provider === 'aws') {
            if (resourceType.includes('ec2') || resourceType.includes('instances')) return `https://console.aws.amazon.com/ec2/v2/home?region=${'us-east-1'}#Instances:instanceId=${id}`;
            if (resourceType.includes('s3')) return `https://s3.console.aws.amazon.com/s3/buckets/${id}`;
            if (resourceType.includes('rds')) return `https://console.aws.amazon.com/rds/home?region=${'us-east-1'}#/database:id=${id};is-cluster=false`;
            if (resourceType.includes('vpc')) return `https://console.aws.amazon.com/vpc/home?region=${'us-east-1'}#vpcs:filter=${id}`;
          }
          if (provider === 'azure') {
            if (resourceType.includes('vm')) return `https://portal.azure.com/#@/resource${'/subscriptions'}/providers/Microsoft.Compute/virtualMachines/${id}`;
            if (resourceType.includes('vnet')) return `https://portal.azure.com/#@/resource${'/subscriptions'}/providers/Microsoft.Network/virtualNetworks/${id}`;
          }
          if (provider === 'gcp') {
            if (resourceType.includes('instances') || resourceType.includes('instance')) return `https://console.cloud.google.com/compute/instancesDetail/zones/-/instances/${id}`;
            if (resourceType.includes('buckets')) return `https://console.cloud.google.com/storage/browser/${id}`;
          }
          return '#';
        }

        function formatKey(key) {
            return key
                .replace(/_/g, ' ')
                .replace(/([A-Z])/g, ' $1')
                .trim()
                .split(' ')
                .map(w => w.charAt(0).toUpperCase() + w.slice(1))
                .join(' ');
        }

        function renderBillingTab(data) {
            const provider = (data.provider || 'aws').toLowerCase();
            const resources = data.resources || {};
            
            let html = `
            <div style="max-width: 900px; margin: 20px 0;">
              <div class="alert alert-info" style="background: #1c4f7c; border-color: #0d6efd;">
                <h5 style="margin-top: 0; color: #fff;">Real-Time Billing Data</h5>
                <p style="margin-bottom: 0; color: #e9ecef;">
                  This application does not currently have direct access to real-time billing data from your cloud provider.
                  To view detailed cost breakdowns and current month charges, please use your cloud provider's native billing portal:
                </p>
              </div>

              <div class="row mt-3 mb-4">
                <div class="col-md-6">
                  <div style="background: #212529; border: 1px solid #495057; border-radius: 8px; padding: 20px; text-align: center;">
                    <h6 style="color: #e9ecef; margin-bottom: 15px;">View Billing Dashboard</h6>
            `;

            if (provider === 'aws') {
                html += `<a href="https://console.aws.amazon.com/billing/home" target="_blank" class="btn btn-primary btn-sm">AWS Billing Console</a>`;
            } else if (provider === 'azure') {
                html += `<a href="https://portal.azure.com/#blade/Microsoft_Azure_Billing/BillingMenuBlade/Overview" target="_blank" class="btn btn-primary btn-sm">Azure Cost Management</a>`;
            } else if (provider === 'gcp') {
                html += `<a href="https://console.cloud.google.com/billing" target="_blank" class="btn btn-primary btn-sm">GCP Billing</a>`;
            } else {
                html += `<p class="text-muted">Select a provider to view billing dashboard</p>`;
            }

            html += `
                    <p class="text-muted mt-3" style="font-size: 12px; margin-bottom: 0;">
                      Click to open your cloud provider's billing dashboard
                    </p>
                  </div>
                </div>

                <div class="col-md-6">
                  <div style="background: #212529; border: 1px solid #495057; border-radius: 8px; padding: 20px;">
                    <h6 style="color: #e9ecef; margin-bottom: 15px;">Resource Summary</h6>
            `;

            // Count resources by type
            let totalResources = 0;
            let countByType = {};
            
            for (const category in resources) {
              for (const resourceType in resources[category]) {
                if (Array.isArray(resources[category][resourceType])) {
                  const count = resources[category][resourceType].filter(r => {
                    const isStopped = r.state && ['stopped', 'deallocated', 'terminated', 'offline'].some(s => r.state.toLowerCase().includes(s));
                    return !isStopped;
                  }).length;
                  if (count > 0) {
                    totalResources += count;
                    countByType[formatKey(resourceType)] = (countByType[formatKey(resourceType)] || 0) + count;
                  }
                }
              }
            }

            html += `<p style="color: #adb5bd; margin: 5px 0;"><strong>Active Resources:</strong> <span style="color: #0d6efd;">${totalResources}</span></p>`;

            for (const type in countByType) {
              html += `<p style="color: #adb5bd; margin: 5px 0; font-size: 13px;">‚Ä¢ ${type}: ${countByType[type]}</p>`;
            }

            html += `
                  </div>
                </div>
              </div>

              <div class="alert alert-warning" style="background: #664d0a; border-color: #ffc107; color: #fff;">
                <h6 style="margin-bottom: 10px; color: #fff;">Estimated Cost Calculation</h6>
                <p style="margin: 5px 0; font-size: 13px;">
                  Accurate cost estimation requires real-time usage metrics and pricing data from your cloud provider.
                  We recommend setting up cost alerts in your billing console to monitor spending.
                </p>
                <p style="margin: 5px 0; font-size: 13px;">
                  For detailed cost analysis, consider using your cloud provider's cost management tools:
                </p>
                <ul style="margin: 10px 0; padding-left: 20px; font-size: 13px;">
                  <li><strong>AWS:</strong> AWS Cost Explorer, Budgets, and Trusted Advisor</li>
                  <li><strong>Azure:</strong> Cost Analysis and Budget Alerts in Cost Management</li>
                  <li><strong>GCP:</strong> Billing Reports and Cost Control Tools</li>
                </ul>
              </div>

              <div style="background: #212529; border: 1px solid #495057; border-radius: 8px; padding: 20px; margin-top: 20px;">
                <h6 style="color: #e9ecef; margin-bottom: 15px;">Cost Optimization Tips</h6>
                <ul style="color: #adb5bd; margin-bottom: 0;">
                  <li>Stop or terminate unused resources to reduce costs</li>
                  <li>Review resource sizing and scale down oversized instances</li>
                  <li>Use reserved instances or commitments for long-running services</li>
                  <li>Enable auto-scaling for variable workloads</li>
                  <li>Monitor unused storage and delete old snapshots/backups</li>
                  <li>Set up billing alerts to catch unexpected cost increases</li>
                </ul>
              </div>
            </div>
            `;
            return html;
        }

        async function loadRecommendations() {
            const loadingDiv = document.getElementById('recommendations-loading');
            const contentDiv = document.getElementById('recommendations-content');
            
            loadingDiv.style.display = 'block';
            loadingDiv.innerHTML = `
                <div class="text-center p-5">
                    <div class="spinner-border text-primary mb-3" role="status"></div>
                    <p class="text-light">Analyzing resources and generating recommendations...</p>
                    <p class="text-muted" style="font-size: 12px;"><i class="bi bi-stars"></i> AI insights are being generated for high-value recommendations</p>
                </div>
            `;
            contentDiv.innerHTML = '';
            
            try {
                const response = await fetch(`/api/metrics/recommendations/${clientId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                renderRecommendations(data);
            } catch (error) {
                contentDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>Error loading recommendations:</strong> ${error.message}
                    </div>`;
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        function renderRecommendations(data) {
            const contentDiv = document.getElementById('recommendations-content');
            const recommendations = data.recommendations || [];
            const summary = data.summary || {};
            
            if (recommendations.length === 0) {
                contentDiv.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-check-circle" style="font-size: 48px; color: #238636;"></i>
                        <h4 class="text-light mt-3">All Good!</h4>
                        <p class="text-muted">No optimization recommendations at this time.</p>
                    </div>`;
                return;
            }
            
            let html = '<div style="margin-bottom: 30px;">';
            
            // Summary Cards
            html += '<div class="row g-3 mb-4">';
            html += `
                <div class="col-md-3">
                    <div class="card text-center" style="background: #161b22; border: 1px solid #30363d;">
                        <div class="card-body">
                            <h2 class="text-light mb-1">${summary.total_recommendations || 0}</h2>
                            <p class="text-muted mb-0" style="font-size: 13px;">Total Recommendations</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center" style="background: #3d1b1b; border: 1px solid #d1242f;">
                        <div class="card-body">
                            <h2 class="text-danger mb-1">${summary.by_severity?.critical || 0}</h2>
                            <p class="text-muted mb-0" style="font-size: 13px;">Critical Issues</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center" style="background: #3d2b1b; border: 1px solid #e09b13;">
                        <div class="card-body">
                            <h2 class="text-warning mb-1">${summary.by_severity?.high || 0}</h2>
                            <p class="text-muted mb-0" style="font-size: 13px;">High Priority</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center" style="background: #1b3d1b; border: 1px solid #238636;">
                        <div class="card-body">
                            <h2 class="text-success mb-1">$${summary.total_potential_savings_monthly?.toFixed(2) || '0.00'}</h2>
                            <p class="text-muted mb-0" style="font-size: 13px;">Potential Savings/Month</p>
                        </div>
                    </div>
                </div>
            `;
            html += '</div>';
            
            // AI Enhancement Banner
            const aiEnhancedCount = recommendations.filter(r => r.ai_enhanced).length;
            if (aiEnhancedCount > 0) {
                html += `
                    <div class="alert mt-3 mb-3" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%); border: 1px solid #667eea; border-radius: 8px;">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-stars text-light me-2" style="font-size: 24px;"></i>
                            <div>
                                <strong class="text-light">AI-Powered Analysis Complete</strong>
                                <p class="text-muted mb-0" style="font-size: 13px;">
                                    ${aiEnhancedCount} high-value recommendation${aiEnhancedCount > 1 ? 's' : ''} enhanced with deep insights, specific actions, and risk assessments
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Recommendations List
            recommendations.forEach((rec, idx) => {
                const severityColors = {
                    'critical': { bg: '#3d1b1b', border: '#d1242f', badge: 'bg-danger' },
                    'high': { bg: '#3d2b1b', border: '#e09b13', badge: 'bg-warning' },
                    'medium': { bg: '#2b2b3d', border: '#6c757d', badge: 'bg-secondary' },
                    'low': { bg: '#1b2b3d', border: '#0d6efd', badge: 'bg-info' }
                };
                
                const categoryIcons = {
                    'cost': 'bi-cash-coin',
                    'security': 'bi-shield-lock',
                    'reliability': 'bi-heartbeat',
                    'operational': 'bi-gear',
                    'performance': 'bi-speedometer2'
                };
                
                const colors = severityColors[rec.severity] || severityColors['low'];
                const icon = categoryIcons[rec.category] || 'bi-info-circle';
                
                html += `
                    <div class="card mb-3" style="background: ${colors.bg}; border: 1px solid ${colors.border}; border-left: 4px solid ${colors.border};">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <i class="bi ${icon}" style="font-size: 20px; color: ${colors.border};"></i>
                                        <h5 class="text-light mb-0">${rec.title}</h5>
                                    </div>
                                    <div class="d-flex gap-2 flex-wrap">
                                        <span class="badge ${colors.badge}" style="font-size: 11px; text-transform: uppercase;">${rec.severity}</span>
                                        <span class="badge bg-dark" style="font-size: 11px;">${rec.category}</span>
                                        ${rec.estimated_savings > 0 ? `<span class="badge" style="background: #238636; font-size: 11px;"><i class="bi bi-piggy-bank"></i> $${rec.estimated_savings.toFixed(2)}/mo</span>` : ''}
                                        ${rec.ai_enhanced ? `<span class="badge" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 11px;"><i class="bi bi-stars"></i> AI Insights</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <p class="text-light mb-2" style="font-size: 14px;">${rec.description}</p>
                            
                            ${rec.impact ? `<p class="mb-2"><span class="badge" style="background: #1f6feb; font-size: 12px;"><i class="bi bi-exclamation-triangle"></i> Impact:</span> <span class="text-light" style="font-size: 13px;">${rec.impact}</span></p>` : ''}
                            
                            ${rec.ai_enhanced && rec.ai_insight ? `
                                <div class="card mt-3 mb-3" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border: 1px solid #667eea;">
                                    <div class="card-body p-3">
                                        <h6 class="mb-2" style="color: #a78bfa;"><i class="bi bi-stars"></i> AI-Powered Insights</h6>
                                        
                                        ${rec.ai_insight.insight ? `
                                            <div class="mb-2">
                                                <strong class="text-light" style="font-size: 12px;">Deep Insight:</strong>
                                                <p class="text-muted mb-0" style="font-size: 12px;">${rec.ai_insight.insight}</p>
                                            </div>
                                        ` : ''}
                                        
                                        ${rec.ai_insight.action ? `
                                            <div class="mb-2">
                                                <strong class="text-light" style="font-size: 12px;">Specific Action:</strong>
                                                <p class="text-muted mb-0" style="font-size: 12px;">${rec.ai_insight.action}</p>
                                            </div>
                                        ` : ''}
                                        
                                        ${rec.ai_insight.risks ? `
                                            <div class="mb-2">
                                                <strong class="text-warning" style="font-size: 12px;"><i class="bi bi-shield-exclamation"></i> Risk Assessment:</strong>
                                                <p class="text-muted mb-0" style="font-size: 12px;">${rec.ai_insight.risks}</p>
                                            </div>
                                        ` : ''}
                                        
                                        ${rec.ai_insight.roi ? `
                                            <div>
                                                <strong class="text-success" style="font-size: 12px;"><i class="bi bi-graph-up"></i> ROI Timeline:</strong>
                                                <p class="text-muted mb-0" style="font-size: 12px;">${rec.ai_insight.roi}</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="card mt-3" style="background: #0d1117; border: 1px solid #30363d;">
                                <div class="card-body p-3">
                                    <h6 class="text-light mb-2"><i class="bi bi-lightbulb text-warning"></i> Recommendation</h6>
                                    <p class="text-muted mb-0" style="font-size: 13px;">${rec.recommendation}</p>
                                </div>
                            </div>
                            
                            ${rec.affected_resources && rec.affected_resources.length > 0 ? `
                                <details class="mt-3" style="cursor: pointer;">
                                    <summary class="text-muted" style="font-size: 13px; user-select: none;">
                                        <i class="bi bi-list-ul"></i> Affected Resources (${rec.affected_resources.length})
                                    </summary>
                                    <div class="mt-2 p-3 rounded" style="background: #0d1117; border: 1px solid #30363d; max-height: 200px; overflow-y: auto;">
                                        ${rec.affected_resources.map(res => {
                                            const resName = res.name || res.id || res.bucket || 'Unknown';
                                            const resDetails = Object.entries(res).filter(([k, v]) => k !== 'name' && k !== 'id').map(([k, v]) => `<span class="text-muted" style="font-size: 11px;">${k}: ${v}</span>`).join(' ¬∑ ');
                                            return `<div class="mb-2"><span class="text-light" style="font-size: 12px;">${resName}</span>${resDetails ? `<br>${resDetails}` : ''}</div>`;
                                        }).join('')}
                                    </div>
                                </details>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            contentDiv.innerHTML = html;
        }

        function switchTab(event, tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));

            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
            
            // Load recommendations when tab is switched to
            if (tab === 'recommendations') {
                const contentDiv = document.getElementById('recommendations-content');
                if (!contentDiv.innerHTML.trim()) {
                    loadRecommendations();
                }
            }
        }

        // Filter resources based on stopped/unused toggles
        function applyFilters() {
            if (!currentResources) return;
            const showStopped = document.getElementById('showStoppedFilter').checked;
            const showUnused = document.getElementById('showUnusedFilter').checked;
            
            const filtered = JSON.parse(JSON.stringify(currentResources)); // deep copy
            
            for (const category in filtered.resources) {
                for (const resourceType in filtered.resources[category]) {
                    if (Array.isArray(filtered.resources[category][resourceType])) {
                        filtered.resources[category][resourceType] = filtered.resources[category][resourceType].filter(item => {
                            const isStopped = item.state && ['stopped', 'deallocated', 'terminated', 'offline'].some(s => item.state.toLowerCase().includes(s));
                            const isUnused = item.unused === true;
                            if (isStopped && !showStopped) return false;
                            if (isUnused && !showUnused) return false;
                            return true;
                        });
                    }
                }
            }
            renderResources(filtered);
        }

        // Initialize page on load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, client ID:', clientId, 'Token exists:', !!token);
            
            // Load client list first - resources will load if client_id is in URL
            loadClients();
            
            // If no client selected, show empty state
            if (!clientId) {
                clearAllResources();
            }
        });
    </script>
  </body>
</html>
